<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Pipeline Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }

        h1 {
            color: #6c63ff;
            border-bottom: 2px solid #6c63ff;
            padding-bottom: 10px;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #6c63ff;
        }

        .success {
            color: #00b894;
        }

        .error {
            color: #ff7675;
        }

        .warning {
            color: #fdcb6e;
        }

        button {
            background: #6c63ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background: #5a54d6;
        }

        #output {
            background: #0f0f1e;
            padding: 15px;
            border-radius: 6px;
            max-height: 500px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.6;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            background: #0f0f1e;
            color: #eee;
            border: 1px solid #6c63ff;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .step {
            margin: 10px 0;
            padding: 8px;
            background: rgba(108, 99, 255, 0.1);
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>ðŸ§ª Markdown Pipeline Test Suite</h1>

    <div class="test-section">
        <h2>ðŸ“‹ Test Input</h2>
        <p>Paste your markdown here or use the sample:</p>
        <textarea id="markdownInput" placeholder="Paste markdown here..."></textarea>
        <br>
        <button onclick="loadSampleMarkdown()">Load Sample Markdown</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>

    <div class="test-section">
        <h2>ðŸš€ Run Tests</h2>
        <button onclick="testStep1()">Step 1: Markdown â†’ HTML</button>
        <button onclick="testStep2()">Step 2: HTML â†’ Cheerio</button>
        <button onclick="testStep3()">Step 3: Extract Tables</button>
        <button onclick="testStep4()">Step 4: Extract KPIs</button>
        <button onclick="testStep5()">Step 5: Build Data Models</button>
        <button onclick="runFullPipeline()">ðŸŽ¯ Run Full Pipeline</button>
    </div>

    <div class="test-section">
        <h2>ðŸ“Š Output</h2>
        <div id="output"></div>
    </div>

    <!-- Load libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cheerio@1.0.0-rc.12/dist/browser/cheerio.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <script>
        const sampleMarkdown = `# ðŸš— Test Report

## Key Performance Indicators

- Fleet Health Score: 85%
- Overall Engagement Rate: 92%
- Service Center Utilization: 65-85%
- Critical Vehicles: 3

## Fleet Table

| Vehicle ID | Status | Priority | Sensor Status |
|------------|--------|----------|---------------|
| VEH001 | Healthy | Low | Normal |
| VEH002 | Warning | Medium | Alert |
| VEH004 | Critical | Critical | Failure |

## Failure Predictions

| Vehicle ID | Component | Failure Probability | Confidence | Cost |
|------------|-----------|--------------------|-----------:|-----:|
| VEH004 | Engine | 95% | 92% | 45000 |
| VEH002 | Brake System | 78% | 85% | 12000 |

## Customer Engagement

| Method | Count |
|--------|------:|
| SMS | 45 |
| Email | 30 |
| App | 20 |

## Service Scheduling

| Vehicle ID | Service Center | Scheduled Date |
|------------|----------------|----------------|
| VEH004 | Mumbai | 2024-01-21 |
| VEH002 | Delhi | 2024-01-22 |
`;

        function loadSampleMarkdown() {
            document.getElementById('markdownInput').value = sampleMarkdown;
            log('âœ… Sample markdown loaded', 'success');
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            output.innerHTML += `<div class="step ${className}">${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function testStep1() {
            clearOutput();
            const markdown = document.getElementById('markdownInput').value;
            if (!markdown) {
                log('âŒ No markdown input provided', 'error');
                return;
            }

            try {
                log('ðŸ”„ Converting markdown to HTML...', 'info');
                const html = marked.parse(markdown);
                log('âœ… Markdown converted successfully!', 'success');
                log(`ðŸ“„ HTML Preview (first 500 chars):\n${html.substring(0, 500)}...`, 'info');
                return html;
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }

        function testStep2() {
            const html = testStep1();
            if (!html) return;

            try {
                log('ðŸ”„ Loading HTML into Cheerio...', 'info');
                const $ = cheerio.load(html);
                log('âœ… HTML loaded into Cheerio!', 'success');
                log(`ðŸ“Š Found ${$('table').length} tables`, 'info');
                log(`ðŸ“Š Found ${$('h1').length} H1 headers`, 'info');
                log(`ðŸ“Š Found ${$('h2').length} H2 headers`, 'info');
                log(`ðŸ“Š Found ${$('li').length} list items`, 'info');
                return $;
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }

        function testStep3() {
            const $ = testStep2();
            if (!$) return;

            try {
                log('ðŸ”„ Extracting tables...', 'info');
                const tables = [];

                $('table').each((i, table) => {
                    const headers = [];
                    $(table).find('th').each((j, th) => {
                        headers.push($(th).text().trim());
                    });

                    const rows = [];
                    $(table).find('tr').each((j, tr) => {
                        const cells = $(tr).find('td');
                        if (cells.length > 0) {
                            const rowObj = {};
                            cells.each((k, td) => {
                                if (headers[k]) {
                                    rowObj[headers[k]] = $(td).text().trim();
                                }
                            });
                            if (Object.keys(rowObj).length) {
                                rows.push(rowObj);
                            }
                        }
                    });

                    tables.push({ headers, rows, rowCount: rows.length });
                });

                log(`âœ… Extracted ${tables.length} tables`, 'success');
                tables.forEach((t, i) => {
                    log(`   Table ${i + 1}: ${t.headers.join(', ')} (${t.rowCount} rows)`, 'info');
                });

                return tables;
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }

        function testStep4() {
            clearOutput();
            const markdown = document.getElementById('markdownInput').value;
            if (!markdown) {
                log('âŒ No markdown input provided', 'error');
                return;
            }

            try {
                log('ðŸ”„ Extracting KPIs with regex...', 'info');
                const kpis = {};

                const patterns = [
                    { name: 'Fleet Health Score', regex: /Fleet Health Score[\s::\-â€“â€”]+([\d.]+)%?/i },
                    { name: 'Engagement Rate', regex: /Overall Engagement Rate[\s::\-â€“â€”]+([\d.]+)%?/i },
                    { name: 'Service Center Utilization', regex: /Service Center Utilization[\s::\-â€“â€”]+([\d]+)[\sâ€“-]*([\d]*)%?/i },
                    { name: 'Critical Vehicles', regex: /Critical Vehicles[\s::\-â€“â€”]+([\d]+)/i }
                ];

                patterns.forEach(({ name, regex }) => {
                    const match = regex.exec(markdown);
                    if (match) {
                        kpis[name] = match[1];
                        log(`âœ… Found: ${name} = ${match[1]}`, 'success');
                    }
                });

                log(`ðŸ“Š Total KPIs extracted: ${Object.keys(kpis).length}`, 'success');
                return kpis;
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }

        function testStep5() {
            clearOutput();
            const markdown = document.getElementById('markdownInput').value;
            if (!markdown) {
                log('âŒ No markdown input provided', 'error');
                return;
            }

            try {
                log('ðŸ”„ Running full data extraction...', 'info');

                // Step 1: Markdown â†’ HTML
                const html = marked.parse(markdown);
                log('âœ… Step 1: Markdown â†’ HTML', 'success');

                // Step 2: Load Cheerio
                const $ = cheerio.load(html);
                log('âœ… Step 2: HTML â†’ Cheerio', 'success');

                // Step 3: Extract Tables
                const tables = [];
                $('table').each((i, table) => {
                    const headers = [];
                    $(table).find('th').each((j, th) => {
                        headers.push($(th).text().trim());
                    });

                    const rows = [];
                    $(table).find('tr').each((j, tr) => {
                        const cells = $(tr).find('td');
                        if (cells.length > 0) {
                            const rowObj = {};
                            cells.each((k, td) => {
                                if (headers[k]) {
                                    rowObj[headers[k]] = $(td).text().trim();
                                }
                            });
                            if (Object.keys(rowObj).length) {
                                rows.push(rowObj);
                            }
                        }
                    });

                    const headerText = headers.join(' ').toLowerCase();
                    let type = 'unknown';
                    if (headerText.includes('vehicle') || headerText.includes('priority')) type = 'fleet';
                    else if (headerText.includes('failure') || headerText.includes('component')) type = 'failures';
                    else if (headerText.includes('engagement') || headerText.includes('method')) type = 'engagement';
                    else if (headerText.includes('service center') || headerText.includes('scheduled')) type = 'scheduling';

                    tables.push({ type, headers, rows });
                });
                log(`âœ… Step 3: Extracted ${tables.length} tables`, 'success');

                // Step 4: Extract KPIs
                const kpis = {};
                const match1 = /Fleet Health Score[\s::\-â€“â€”]+([\d.]+)%?/i.exec(markdown);
                if (match1) kpis.fleetHealthScore = parseFloat(match1[1]);

                const match2 = /Overall Engagement Rate[\s::\-â€“â€”]+([\d.]+)%?/i.exec(markdown);
                if (match2) kpis.engagementRate = parseFloat(match2[1]);

                const match3 = /Critical Vehicles[\s::\-â€“â€”]+([\d]+)/i.exec(markdown);
                if (match3) kpis.criticalVehicles = parseInt(match3[1]);

                log(`âœ… Step 4: Extracted ${Object.keys(kpis).length} KPIs`, 'success');

                // Step 5: Build Data Models
                const data = {
                    fleet: {},
                    failures: {},
                    engagement: {},
                    scheduling: {},
                    kpis: kpis
                };

                tables.forEach(table => {
                    log(`   Processing ${table.type} table (${table.rows.length} rows)`, 'info');
                    switch (table.type) {
                        case 'fleet':
                            data.fleet.vehicles = table.rows;
                            data.fleet.total = table.rows.length;
                            break;
                        case 'failures':
                            data.failures.predictions = table.rows;
                            break;
                        case 'engagement':
                            data.engagement.methods = table.rows;
                            break;
                        case 'scheduling':
                            data.scheduling.appointments = table.rows;
                            break;
                    }
                });

                log('âœ… Step 5: Data models built!', 'success');
                log('ðŸ“Š Final Data Structure:', 'success');
                log(JSON.stringify(data, null, 2), 'info');

                return data;
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function runFullPipeline() {
            testStep5();
        }

        // Load sample on page load
        window.onload = () => {
            log('ðŸŽ‰ Markdown Pipeline Test Suite Ready!', 'success');
            log('ðŸ‘‰ Click "Load Sample Markdown" to get started', 'info');
        };
    </script>
</body>

</html>